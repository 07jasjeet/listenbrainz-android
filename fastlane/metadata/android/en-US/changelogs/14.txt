Code refactored in places and some bugs fixed.